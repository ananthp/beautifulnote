<div id="related-posts">
    {% assign maxRelatedPosts = 3 %}
    {% assign minCommonTags =  2 %}
    {% assign relatedPostCount = 0 %}
    {% assign hasTitleSet = false %}
    {% assign hasRelatedPosts = false %}

    {% for post in site.posts %}
        {% assign sameTagCount = 0 %}

        {% for tag in post.tags %}
            {% if post.url != page.url %}
                {% if page.tags contains tag %}
                    {% assign sameTagCount = sameTagCount | plus: 1 %}
                {% endif %}
            {% endif %}
        {% endfor %}

        {% if sameTagCount >= minCommonTags %}
            {% assign hasRelatedPosts = true %}
            {% if hasTitleSet == false %}
                <div class='related-posts-heading'>Related</div>
                <ul class='related-posts'>
                {% assign hasTitleSet = true %}
            {% endif %}

            <li class="related-post">
                <a href="{{ site.baseurl }}{{ post.url }}">{{ post.title }}</a>
            </li>
            {% assign relatedPostCount = relatedPostCount | plus: 1 %}
            {% if relatedPostCount >= maxRelatedPosts %}
                {% break %}
            {% endif %}
        {% endif %}
    {% endfor %}

    {% if hasRelatedPosts %}
        </ul>
    {% endif %}
</div>
